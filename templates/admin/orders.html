<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background-color: var(--bg-light, #f0f2f5); }        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .content-wrapper { padding: 2em; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; }
        .page-header h1 { margin: 0; font-size: 1.5em; }
        .page-header p { margin: 0; color: #6c757d; }
        .filter-controls { margin-bottom: 1.5em; }
        .filter-controls label { margin-right: 10px; }
        .filter-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #6c757d; font-weight: normal; text-transform: uppercase; font-size: 0.85em; }
        th a { color: #6c757d; text-decoration: none; }
        th a:hover { text-decoration: underline; }
        .status { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; text-transform: capitalize; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-shipped { background-color: #cce5ff; color: #004085; }
        .status-processing { background-color: #d1ecf1; color: #0c5460; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .actions button { padding: 8px 12px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd; background-color: #f8f9fa; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; border-radius: 8px; width: 450px; max-width: 90%; }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; position: relative; }
        .modal-header h2 { margin: 0; }
        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 30px; }
        .order-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .detail-item h4 { margin: 0 0 5px; color: #6c757d; font-size: 0.9em; }
        .detail-item p { margin: 0; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #eee; text-align: right; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #5a685a; color: white; }
        .btn-cancel { background-color: #f1f1f1; color: #333; margin-right: 10px; }
        .pagination { display: flex; justify-content: center; margin-top: 2em; }
        .pagination a, .pagination span { color: #5a685a; padding: 8px 16px; text-decoration: none; transition: background-color .3s; border: 1px solid #ddd; margin: 0 4px; }
        .pagination a.active { background-color: #5a685a; color: white; border: 1px solid #5a685a; }
        .pagination a:hover:not(.active) { background-color: #ddd; }
        .pagination .disabled { color: #ccc; border-color: #eee; }
                .flash-message { padding: 1rem; margin-bottom: 1rem; border-radius: 5px; font-weight: 500; }
        .flash-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    </style>
    </style>
</head>
<body>
    {% include 'admin/partials/sidebar.html' %}
    <div class="main-content">
        {% include 'admin/partials/header.html' %}
        <main class="content-wrapper">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="filter-controls">
                <form method="get" action="{{ url_for('admin_orders') }}">
                    
                    <label for="status-filter">Filter by status:</label>
                    <select name="status" id="status-filter" onchange="this.form.submit()">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Statuses</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="shipped" {% if current_status == 'shipped' %}selected{% endif %}>Shipped</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if current_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>
                            <a href="{{ url_for('admin_orders', status=current_status, sort_by='amount', order='asc' if current_sort_by == 'amount' and current_sort_order == 'desc' else 'desc') }}">
                                Total Amount {% if current_sort_by == 'amount' %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th>Status</th>
                                                <th>
                            <a href="{{ url_for('admin_orders', status=current_status, sort_by='date', order='asc' if current_sort_by == 'date' and current_sort_order == 'desc' else 'desc') }}">
                                Order Date {% if current_sort_by == 'date' %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                            </a>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.customer_name }}</td>
                        <td>P{{ "{:,.2f}".format(order.totalamount) }}</td>
                        <td><span class="status status-{{ order.status }}">{{ order.status }}</span></td>
                        <td>{{ order.createdat.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="actions">
                            <button 
                                onclick="openStatusModal(this)"
                                data-id="{{ order.id }}"
                                data-status="{{ order.status }}"
                                data-reason="{{ order.cancellation_reason or '' }}"
                            >Update Status</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
                       <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ url_for('admin_orders', page=page-1) }}">« Previous</a>
                {% else %}
                    <span class="disabled">« Previous</span>
                {% endif %}
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <a class="active">{{ p }}</a>
                    {% else %}
                        <a href="{{ url_for('admin_orders', page=p) }}">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                {% if page < total_pages %}
                    <a href="{{ url_for('admin_orders', page=page+1) }}">Next »</a>
                {% else %}
                    <span class="disabled">Next »</span>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Status Update Modal -->
    <div id="status-modal" class="modal-overlay">
        <div class="modal-content">
            <form id="status-form" method="post" novalidate>
                {{ form.hidden_tag() }}
                <div class="modal-header">
                    <h2 id="modal-title">Update Order Status</h2>
                    <span class="close-modal" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Change the status for Order #<strong id="modal-order-id"></strong>.</p>
                    <div class="form-group">
                        <label for="status">New Status</label>
                        {{ form.status(id="status", style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;") }}
                    </div>

                    <div class="form-group" id="cancellation-reason-group" style="display: none;">
                        <label for="reason">Reason for Cancellation</label>
                        {{ form.reason(id="reason", rows="3", placeholder="Please explain why this order is being declined...", style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-save" id="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('status-modal');
        const statusForm = document.getElementById('status-form');
        const modalOrderId = document.getElementById('modal-order-id');
        const statusSelect = document.getElementById('status'); // ID matches WTForms render
        const cancellationReasonGroup = document.getElementById('cancellation-reason-group');
        const reasonInput = document.getElementById('reason');

        // Add error styling dynamically if not present
        if (!document.getElementById('error-style')) {
            const style = document.createElement('style');
            style.id = 'error-style';
            style.textContent = `
                .error-text { color: #dc3545; font-size: 0.8em; margin-top: 4px; display: block; }
                .form-group input.is-invalid, .form-group select.is-invalid, .form-group textarea.is-invalid { border-color: #dc3545; }
            `;
            document.head.appendChild(style);
        }

        function toggleCancellationReason() {
            // Show if status is 'cancelled', otherwise hide
            if (statusSelect.value === 'cancelled') {
                cancellationReasonGroup.style.display = 'block';
                // If opening an existing cancelled order, the value is populated by openStatusModal
            } else {
                cancellationReasonGroup.style.display = 'none';
            }
        }
        statusSelect.addEventListener('change', toggleCancellationReason);

        function closeModal() {
            modal.style.display = 'none';
            // Clear errors
            document.querySelectorAll('.error-text').forEach(el => el.remove());
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            statusForm.reset();
        }

        function openStatusModal(btn) {
            const orderId = btn.dataset.id;
            const currentStatus = btn.dataset.status;
            const reason = btn.dataset.reason;

            statusForm.action = `/admin/orders/update_status/${orderId}`;
            modalOrderId.textContent = orderId;

            // Populate the reason field
            if (reasonInput) {
                reasonInput.value = reason || '';
            }

            // Allowed transitions mirror server-side rules
            const allowed = {
                'pending': ['processing', 'cancelled'],
                'processing': ['shipped', 'cancelled'],
                'shipped': ['completed'],
                'completed': [],
                'cancelled': []
            };

            // Enable/disable options based on current status
            Array.from(statusSelect.options).forEach(opt => {
                if (opt.value === currentStatus) {
                    opt.disabled = false;
                } else {
                    opt.disabled = !allowed[currentStatus] || !allowed[currentStatus].includes(opt.value);
                }
            });

            // Set value after disabling/enabling
            statusSelect.value = currentStatus;
            
            // Populate the reason field visibility
            toggleCancellationReason();
            
            modal.style.display = 'flex';
        }

        window.onclick = (event) => {
            if (event.target == modal) closeModal();
        };

        // Handle Form Submission via AJAX
        statusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(statusForm);
            const submitBtn = document.getElementById('save-btn');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            // Clear previous errors
            document.querySelectorAll('.error-text').forEach(el => el.remove());
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

            fetch(statusForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(result => {
                if (result.status === 200 && result.body.success) {
                    window.location.reload();
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    if (result.body.errors) {
                        for (const [field, errors] of Object.entries(result.body.errors)) {
                            const input = document.getElementById(field);
                            if (input) {
                                input.classList.add('is-invalid');
                                const errorSmall = document.createElement('small');
                                errorSmall.className = 'error-text';
                                errorSmall.textContent = errors[0];
                                input.parentNode.appendChild(errorSmall);
                            }
                        }
                        // If reason error exists but field is hidden (edge case), show it
                        if (result.body.errors.reason && statusSelect.value === 'cancelled') {
                            cancellationReasonGroup.style.display = 'block';
                        }
                    } else {
                        alert('An error occurred. Please try again.');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            })
        });

        // Fade out flash messages
        window.addEventListener('DOMContentLoaded', (event) => {
            const flashMessages = document.querySelectorAll('.flash-message');
            if (flashMessages.length > 0) {
                setTimeout(() => {
                    flashMessages.forEach(message => {
                        message.style.transition = 'opacity 0.5s ease';
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 500); // Remove after fade
                    });
                }, 3000); // 3 seconds
            }
        });
    </script>
</body>
</html>