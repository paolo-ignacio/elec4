<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background-color: var(--bg-light, #f0f2f5); }        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .content-wrapper { padding: 2em; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; }
        .page-header h1 { margin: 0; font-size: 1.5em; }
        .page-header p { margin: 0; color: #6c757d; }
        .filter-controls { margin-bottom: 1.5em; }
        .filter-controls label { margin-right: 10px; }
        .filter-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #6c757d; font-weight: normal; text-transform: uppercase; font-size: 0.85em; }
        th a { color: #6c757d; text-decoration: none; }
        th a:hover { text-decoration: underline; }
        .status { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; text-transform: capitalize; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-shipped { background-color: #cce5ff; color: #004085; }
        .status-processing { background-color: #d1ecf1; color: #0c5460; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .actions button { padding: 8px 12px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd; background-color: #f8f9fa; }
        /* Payment Status Badges */
        .payment-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; display: inline-block; }
        .payment-pending { background-color: #fff3cd; color: #856404; }
        .payment-pending_verification { background-color: #e0cffc; color: #6f42c1; }
        .payment-paid { background-color: #d4edda; color: #155724; }
        .payment-failed { background-color: #f8d7da; color: #721c24; }
        .payment-method { font-size: 0.85em; color: #6c757d; }
        .verify-btn { padding: 6px 10px; font-size: 0.8em; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .verify-btn.approve { background-color: #28a745; color: white; }
        .verify-btn.reject { background-color: #dc3545; color: white; }
        .verify-btn:hover { opacity: 0.9; }
        .view-proof-btn { padding: 6px 10px; font-size: 0.8em; border: 1px solid #6f42c1; background: transparent; color: #6f42c1; border-radius: 4px; cursor: pointer; }
        .view-proof-btn:hover { background-color: #6f42c1; color: white; }
        .payment-cell { min-width: 150px; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; border-radius: 8px; width: 450px; max-width: 90%; }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; position: relative; }
        .modal-header h2 { margin: 0; }
        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body { padding: 30px; }
        .order-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .detail-item h4 { margin: 0 0 5px; color: #6c757d; font-size: 0.9em; }
        .detail-item p { margin: 0; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #eee; text-align: right; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #5a685a; color: white; }
        .btn-cancel { background-color: #f1f1f1; color: #333; margin-right: 10px; }
        .pagination { display: flex; justify-content: center; margin-top: 2em; }
        .pagination a, .pagination span { color: #5a685a; padding: 8px 16px; text-decoration: none; transition: background-color .3s; border: 1px solid #ddd; margin: 0 4px; }
        .pagination a.active { background-color: #5a685a; color: white; border: 1px solid #5a685a; }
        .pagination a:hover:not(.active) { background-color: #ddd; }
        .pagination .disabled { color: #ccc; border-color: #eee; }
                .flash-message { padding: 1rem; margin-bottom: 1rem; border-radius: 5px; font-weight: 500; }
        .flash-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        /* Payment Proof Modal */
        .proof-modal-content { width: 600px; max-width: 95%; }
        .proof-image-container { text-align: center; margin: 20px 0; }
        .proof-image-container img { max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd; }
        .proof-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .proof-detail-item { background: #f8f9fa; padding: 12px; border-radius: 6px; }
        .proof-detail-item label { font-size: 0.8em; color: #6c757d; display: block; margin-bottom: 4px; }
        .proof-detail-item span { font-weight: 600; color: #333; }
        /* Order Details Modal */
        .order-modal-content { width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
        .order-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
        .order-modal-header h2 { margin: 0; font-size: 1.3em; }
        .order-header-info { display: flex; align-items: center; gap: 15px; }
        .order-modal-body { padding: 20px 30px; }
        .order-section { margin-bottom: 25px; }
        .order-section h3 { font-size: 1em; color: #333; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #5a685a; display: flex; align-items: center; gap: 8px; }
        .order-section h3 svg { color: #5a685a; }
        .order-info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .order-info-item { background: #f8f9fa; padding: 12px; border-radius: 6px; }
        .order-info-item label { font-size: 0.75em; color: #6c757d; display: block; margin-bottom: 4px; text-transform: uppercase; }
        .order-info-item span { font-weight: 600; color: #333; font-size: 0.95em; }
        .order-items-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .order-item-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; gap: 15px; }
        .order-item-row:last-child { border-bottom: none; }
        .order-item-row img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }
        .order-item-info { flex: 1; }
        .order-item-info .name { font-weight: 600; color: #333; display: block; }
        .order-item-info .qty { font-size: 0.85em; color: #6c757d; }
        .order-item-price { text-align: right; }
        .order-item-price .unit { font-size: 0.85em; color: #6c757d; display: block; }
        .order-item-price .subtotal { font-weight: 600; color: #5a685a; }
        .order-total-row { display: flex; justify-content: space-between; padding: 15px; background: #5a685a; color: white; font-weight: 600; border-radius: 0 0 8px 8px; }
        .payment-proof-preview { margin-top: 15px; text-align: center; }
        .payment-proof-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
        .payment-proof-preview img:hover { opacity: 0.9; }
        .shipping-address-text { background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-line; line-height: 1.6; }
        .status-update-section { background: #f0f2f5; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .status-update-section h3 { margin-top: 0; }
        .form-row { display: flex; gap: 15px; align-items: flex-end; }
        .form-row .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .payment-actions { display: flex; gap: 10px; margin-top: 15px; }
        .payment-actions .btn { flex: 1; padding: 12px; text-align: center; }
        .verification-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .verification-actions button { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-approve { background-color: #28a745; color: white; }
        .btn-reject { background-color: #dc3545; color: white; }
        .btn-approve:hover { background-color: #218838; }
        .btn-reject:hover { background-color: #c82333; }
        .reject-reason-group { margin-top: 15px; display: none; }
        .reject-reason-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; }
        .no-proof { color: #6c757d; font-style: italic; text-align: center; padding: 40px; }
    </style>
</head>
<body>
    {% include 'admin/partials/sidebar.html' %}
    <div class="main-content">
        {% include 'admin/partials/header.html' %}
        <main class="content-wrapper">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="filter-controls">
                <form method="get" action="{{ url_for('admin_orders') }}">
                    
                    <label for="status-filter">Filter by status:</label>
                    <select name="status" id="status-filter" onchange="this.form.submit()">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Statuses</option>
                        <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if current_status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="shipped" {% if current_status == 'shipped' %}selected{% endif %}>Shipped</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if current_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>
                            <a href="{{ url_for('admin_orders', status=current_status, sort_by='amount', order='asc' if current_sort_by == 'amount' and current_sort_order == 'desc' else 'desc') }}">
                                Total {% if current_sort_by == 'amount' %}{{ 'â†‘' if current_sort_order == 'asc' else 'â†“' }}{% endif %}
                            </a>
                        </th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>
                            <a href="{{ url_for('admin_orders', status=current_status, sort_by='date', order='asc' if current_sort_by == 'date' and current_sort_order == 'desc' else 'desc') }}">
                                Date {% if current_sort_by == 'date' %}{{ 'â†‘' if current_sort_order == 'asc' else 'â†“' }}{% endif %}
                            </a>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>#{{ "%06d"|format(order.id) }}</td>
                        <td>{{ order.customer_name }}</td>
                        <td>â‚±{{ "{:,.2f}".format(order.totalamount) }}</td>
                        <td><span class="status status-{{ order.status }}">{{ order.status }}</span></td>
                        <td class="payment-cell">
                            {% if order.payment_method %}
                                <div class="payment-method">{{ order.payment_method }}</div>
                                <span class="payment-badge payment-{{ order.payment_status or 'pending' }}">
                                    {% if order.payment_status == 'pending_verification' %}
                                        Needs Verification
                                    {% elif order.payment_status == 'paid' %}
                                        Paid
                                    {% elif order.payment_status == 'failed' %}
                                        Rejected
                                    {% else %}
                                        {{ order.payment_status or 'Pending' }}
                                    {% endif %}
                                </span>
                                {% if order.payment_status == 'pending_verification' and order.proof_image %}
                                    <div style="margin-top: 5px;">
                                        <button class="view-proof-btn" onclick="openProofModal({{ order.payment_id }})">
                                            View Proof
                                        </button>
                                    </div>
                                {% endif %}
                            {% else %}
                                <span class="payment-method">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ order.createdat.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="actions">
                            <button onclick="openOrderModal({{ order.id }})">View Details</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
                       <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ url_for('admin_orders', page=page-1) }}">Â« Previous</a>
                {% else %}
                    <span class="disabled">Â« Previous</span>
                {% endif %}
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                        <a class="active">{{ p }}</a>
                    {% else %}
                        <a href="{{ url_for('admin_orders', page=p) }}">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                {% if page < total_pages %}
                    <a href="{{ url_for('admin_orders', page=page+1) }}">Next Â»</a>
                {% else %}
                    <span class="disabled">Next Â»</span>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Payment Proof Modal -->
    <div id="proof-modal" class="modal-overlay">
        <div class="modal-content proof-modal-content">
            <div class="modal-header">
                <h2>Payment Verification</h2>
                <span class="close-modal" onclick="closeProofModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="proof-loading" style="text-align: center; padding: 40px;">Loading...</div>
                <div id="proof-content" style="display: none;">
                    <div class="proof-details">
                        <div class="proof-detail-item">
                            <label>Order</label>
                            <span id="proof-order-id">#000000</span>
                        </div>
                        <div class="proof-detail-item">
                            <label>Customer</label>
                            <span id="proof-customer"></span>
                        </div>
                        <div class="proof-detail-item">
                            <label>Payment Method</label>
                            <span id="proof-method"></span>
                        </div>
                        <div class="proof-detail-item">
                            <label>Amount</label>
                            <span id="proof-amount"></span>
                        </div>
                        <div class="proof-detail-item" style="grid-column: span 2;">
                            <label>Reference Number</label>
                            <span id="proof-reference"></span>
                        </div>
                    </div>
                    <div class="proof-image-container">
                        <p style="font-weight: 600; margin-bottom: 10px;">Payment Proof Screenshot:</p>
                        <img id="proof-image" src="" alt="Payment Proof">
                    </div>
                    <div class="reject-reason-group" id="reject-reason-group">
                        <label style="font-weight: 600;">Rejection Reason (required):</label>
                        <textarea id="reject-reason" rows="3" placeholder="Please provide a reason for rejecting this payment..."></textarea>
                    </div>
                    <div class="verification-actions">
                        <button type="button" class="btn-reject" id="reject-btn" onclick="toggleRejectReason()">Reject Payment</button>
                        <button type="button" class="btn-approve" id="approve-btn" onclick="verifyPayment('approve')">Approve Payment</button>
                    </div>
                </div>
                <div id="proof-none" class="no-proof" style="display: none;">
                    <p>No payment proof has been uploaded for this order.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content order-modal-content">
            <div class="order-modal-header">
                <div class="order-header-info">
                    <h2>Order <span id="order-modal-id">#000000</span></h2>
                    <span class="status" id="order-modal-status">pending</span>
                </div>
                <span class="close-modal" onclick="closeOrderModal()">&times;</span>
            </div>
            <div class="order-modal-body" id="order-modal-body">
                <div style="text-align: center; padding: 40px;">Loading order details...</div>
            </div>
        </div>
    </div>

    <script>
        // Payment Proof Modal
        const proofModal = document.getElementById('proof-modal');
        let currentPaymentId = null;
        let rejectMode = false;

        function openProofModal(paymentId) {
            currentPaymentId = paymentId;
            proofModal.style.display = 'flex';
            document.getElementById('proof-loading').style.display = 'block';
            document.getElementById('proof-content').style.display = 'none';
            document.getElementById('proof-none').style.display = 'none';
            document.getElementById('reject-reason-group').style.display = 'none';
            document.getElementById('reject-reason').value = '';
            rejectMode = false;
            document.getElementById('reject-btn').textContent = 'Reject Payment';

            fetch(`/admin/payments/proof/${paymentId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('proof-loading').style.display = 'none';
                    if (data.success && data.payment) {
                        const payment = data.payment;
                        document.getElementById('proof-order-id').textContent = `#${String(payment.order_id).padStart(6, '0')}`;
                        document.getElementById('proof-customer').textContent = payment.customer_name;
                        // Payment method now matches database enum directly
                        document.getElementById('proof-method').textContent = payment.method || 'N/A';
                        document.getElementById('proof-amount').textContent = `â‚±${payment.total_amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
                        document.getElementById('proof-reference').textContent = payment.reference_no || 'N/A';

                        if (payment.proof_image) {
                            document.getElementById('proof-image').src = `/static/${payment.proof_image}`;
                            document.getElementById('proof-content').style.display = 'block';
                        } else {
                            document.getElementById('proof-none').style.display = 'block';
                        }
                    } else {
                        document.getElementById('proof-none').style.display = 'block';
                        document.getElementById('proof-none').innerHTML = '<p>Error loading payment details.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('proof-loading').style.display = 'none';
                    document.getElementById('proof-none').style.display = 'block';
                    document.getElementById('proof-none').innerHTML = '<p>Error loading payment details.</p>';
                });
        }

        function closeProofModal() {
            proofModal.style.display = 'none';
            currentPaymentId = null;
            rejectMode = false;
        }

        function toggleRejectReason() {
            const rejectGroup = document.getElementById('reject-reason-group');
            const rejectBtn = document.getElementById('reject-btn');

            if (!rejectMode) {
                rejectGroup.style.display = 'block';
                rejectBtn.textContent = 'Confirm Rejection';
                rejectMode = true;
            } else {
                // Confirm rejection
                verifyPayment('reject');
            }
        }

        function verifyPayment(action) {
            if (!currentPaymentId) return;

            const approveBtn = document.getElementById('approve-btn');
            const rejectBtn = document.getElementById('reject-btn');

            if (action === 'reject') {
                const reason = document.getElementById('reject-reason').value.trim();
                if (!reason) {
                    alert('Please provide a reason for rejection.');
                    document.getElementById('reject-reason').focus();
                    return;
                }
            }

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            approveBtn.textContent = 'Processing...';
            rejectBtn.textContent = 'Processing...';

            const payload = {
                action: action,
                reason: document.getElementById('reject-reason').value.trim()
            };

            fetch(`/admin/payments/verify/${currentPaymentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeProofModal();
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                    approveBtn.textContent = 'Approve Payment';
                    rejectBtn.textContent = rejectMode ? 'Confirm Rejection' : 'Reject Payment';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing the payment.');
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                approveBtn.textContent = 'Approve Payment';
                rejectBtn.textContent = rejectMode ? 'Confirm Rejection' : 'Reject Payment';
            });
        }

        // Close proof modal on overlay click
        proofModal.addEventListener('click', function(e) {
            if (e.target === proofModal) closeProofModal();
        });

        // ================================
        // ORDER DETAILS MODAL
        // ================================
        const orderModal = document.getElementById('order-modal');
        let currentOrderId = null;
        let currentOrderData = null;

        function openOrderModal(orderId) {
            currentOrderId = orderId;
            orderModal.style.display = 'flex';
            document.getElementById('order-modal-id').textContent = `#${String(orderId).padStart(6, '0')}`;
            document.getElementById('order-modal-body').innerHTML = '<div style="text-align: center; padding: 40px;">Loading order details...</div>';

            fetch(`/admin/orders/details/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentOrderData = data;
                        renderOrderDetails(data.order, data.items);
                    } else {
                        document.getElementById('order-modal-body').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading order details.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('order-modal-body').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading order details.</div>';
                });
        }

        function closeOrderModal() {
            orderModal.style.display = 'none';
            currentOrderId = null;
            currentOrderData = null;
        }

        orderModal.addEventListener('click', function(e) {
            if (e.target === orderModal) closeOrderModal();
        });

        function renderOrderDetails(order, items) {
            const statusClass = `status-${order.status}`;
            document.getElementById('order-modal-status').className = `status ${statusClass}`;
            document.getElementById('order-modal-status').textContent = order.status;

            const statusNames = {
                'pending': 'Pending',
                'pending_verification': 'Needs Verification',
                'paid': 'Paid',
                'failed': 'Rejected'
            };

            // Payment method now matches database enum directly
            const paymentMethod = order.payment_method || 'N/A';
            const paymentStatus = statusNames[order.payment_status] || order.payment_status || 'Pending';
            const paymentStatusClass = `payment-${order.payment_status || 'pending'}`;

            // Check if payment method is Cash on Delivery (handle both old 'cod' and new 'Cash on Delivery' values)
            const isCOD = !order.payment_method || order.payment_method.toLowerCase() === 'cod' || order.payment_method === 'Cash on Delivery';

            let html = `
                <!-- Customer & Order Info -->
                <div class="order-section">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Customer Information
                    </h3>
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <label>Customer Name</label>
                            <span>${order.customer_name || 'N/A'}</span>
                        </div>
                        <div class="order-info-item">
                            <label>Email</label>
                            <span>${order.customer_email || 'N/A'}</span>
                        </div>
                        <div class="order-info-item">
                            <label>Order Date</label>
                            <span>${order.createdat || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="order-section">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                            <path d="M3 6h18"></path>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                        Order Items (${items.length})
                    </h3>
                    <div class="order-items-list">
                        ${items.map(item => `
                            <div class="order-item-row">
                                <img src="${item.imagepath || 'https://via.placeholder.com/50'}" alt="${item.product_name}">
                                <div class="order-item-info">
                                    <span class="name">${item.product_name}</span>
                                    <span class="qty">Qty: ${item.quantity}</span>
                                </div>
                                <div class="order-item-price">
                                    <span class="unit">â‚±${item.price.toFixed(2)} each</span>
                                    <span class="subtotal">â‚±${item.subtotal.toFixed(2)}</span>
                                </div>
                            </div>
                        `).join('')}
                        <div class="order-total-row">
                            <span>Total Amount</span>
                            <span>â‚±${order.totalamount.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="order-section">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        Payment Information
                    </h3>
                    <div class="order-info-grid">
                        <div class="order-info-item">
                            <label>Payment Method</label>
                            <span>${paymentMethod}</span>
                        </div>
                        <div class="order-info-item">
                            <label>Payment Status</label>
                            <span class="payment-badge ${paymentStatusClass}">${paymentStatus}</span>
                        </div>
                        <div class="order-info-item">
                            <label>Reference No.</label>
                            <span>${order.reference_no || 'N/A'}</span>
                        </div>
                    </div>
                    ${order.proof_image ? `
                        <div class="payment-proof-preview">
                            <p style="font-weight: 600; margin-bottom: 10px; text-align: left;">Payment Proof:</p>
                            <img src="/static/${order.proof_image}" alt="Payment Proof" onclick="window.open(this.src, '_blank')">
                        </div>
                    ` : `
                        <div class="no-proof-notice" style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-top: 10px;">
                            <p style="margin: 0; font-size: 0.9em;">No payment proof uploaded yet.</p>
                        </div>
                    `}

                    ${!isCOD ? `
                        <!-- Payment Status Update Section -->
                        <div class="payment-status-update" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 15px 0; font-size: 0.95em; color: #333;">Update Payment Status</h4>

                            ${!order.payment_status || order.payment_status === 'pending' || order.payment_status === 'pending_verification' ? `
                                <div class="payment-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-approve" onclick="verifyOrderPayment('approve')" style="flex: 1; min-width: 140px;">
                                        âœ“ Mark as Paid
                                    </button>
                                    <button class="btn btn-reject" onclick="showRejectForm()" style="flex: 1; min-width: 140px;">
                                        âœ— Reject Payment
                                    </button>
                                </div>
                                <div id="reject-form-inline" style="display: none; margin-top: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Rejection Reason (required):</label>
                                        <textarea id="reject-reason-inline" rows="3" placeholder="Please provide a reason for rejection..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                                    </div>
                                    <button class="btn btn-reject" onclick="verifyOrderPayment('reject')" style="margin-top: 10px;">
                                        Confirm Rejection
                                    </button>
                                </div>
                            ` : order.payment_status === 'paid' ? `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span class="payment-badge payment-paid" style="font-size: 0.9em;">âœ“ Payment Verified</span>
                                    <span style="color: #6c757d; font-size: 0.85em;">Paid at: ${order.paid_at || 'N/A'}</span>
                                </div>
                            ` : order.payment_status === 'failed' ? `
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <span class="payment-badge payment-failed" style="font-size: 0.9em;">âœ— Payment Rejected</span>
                                    <button class="btn" onclick="verifyOrderPayment('approve')" style="background: #28a745; color: white; padding: 8px 16px;">
                                        Re-verify as Paid
                                    </button>
                                </div>
                            ` : `
                                <p style="color: #6c757d; margin: 0;">Current status: ${paymentStatus}</p>
                            `}
                        </div>
                    ` : `
                        <div class="cod-notice" style="margin-top: 15px; padding: 12px; background: #d4edda; color: #155724; border-radius: 6px;">
                            <p style="margin: 0; font-size: 0.9em;">ðŸ’µ Cash on Delivery - Payment will be collected upon delivery.</p>
                        </div>
                    `}
                </div>

                <!-- Shipping Address -->
                <div class="order-section">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        Shipping Address
                    </h3>
                    <div class="shipping-address-text">${order.shippingaddress || 'No address provided'}</div>
                </div>

                ${order.cancellation_reason ? `
                    <div class="order-section">
                        <h3 style="border-color: #dc3545;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Cancellation Reason
                        </h3>
                        <div class="shipping-address-text" style="background: #f8d7da; color: #721c24;">${order.cancellation_reason}</div>
                    </div>
                ` : ''}

                <!-- Status Update -->
                <div class="status-update-section">
                    <h3>Update Order Status</h3>
                    <form id="inline-status-form" onsubmit="updateOrderStatus(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>New Status</label>
                                <select id="inline-status" name="status">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-save" id="update-status-btn">Update Status</button>
                            </div>
                        </div>
                        <div class="form-group" id="inline-cancel-reason" style="display: ${order.status === 'cancelled' ? 'block' : 'none'}; margin-top: 15px;">
                            <label>Cancellation Reason</label>
                            <textarea id="inline-reason" name="reason" rows="2" placeholder="Reason for cancellation...">${order.cancellation_reason || ''}</textarea>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('order-modal-body').innerHTML = html;

            // Apply status transition rules
            applyStatusRules(order.status);

            // Toggle cancellation reason visibility
            document.getElementById('inline-status').addEventListener('change', function() {
                document.getElementById('inline-cancel-reason').style.display = this.value === 'cancelled' ? 'block' : 'none';
            });
        }

        function applyStatusRules(currentStatus) {
            const allowed = {
                'pending': ['pending', 'processing', 'cancelled'],
                'processing': ['processing', 'shipped', 'cancelled'],
                'shipped': ['shipped', 'completed'],
                'completed': ['completed'],
                'cancelled': ['cancelled']
            };

            const select = document.getElementById('inline-status');
            Array.from(select.options).forEach(opt => {
                opt.disabled = !allowed[currentStatus] || !allowed[currentStatus].includes(opt.value);
            });
        }

        function showRejectForm() {
            document.getElementById('reject-form-inline').style.display = 'block';
        }

        function verifyOrderPayment(action) {
            if (!currentOrderData || !currentOrderData.order.payment_id) {
                alert('Payment ID not found. Please refresh the page and try again.');
                return;
            }

            if (action === 'reject') {
                const rejectTextarea = document.getElementById('reject-reason-inline');
                if (rejectTextarea) {
                    const reason = rejectTextarea.value.trim();
                    if (!reason) {
                        alert('Please provide a rejection reason');
                        return;
                    }
                }
            }

            const rejectReason = document.getElementById('reject-reason-inline');
            const payload = {
                action: action,
                reason: action === 'reject' && rejectReason ? rejectReason.value.trim() : ''
            };

            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

            fetch(`/admin/payments/verify/${currentOrderData.order.payment_id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message || 'Error processing payment');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing payment');
            });
        }

        function updateOrderStatus(e) {
            e.preventDefault();
            const form = document.getElementById('inline-status-form');
            const btn = document.getElementById('update-status-btn');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Updating...';

            const formData = new FormData(form);

            fetch(`/admin/orders/update_status/${currentOrderId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order status updated successfully');
                    window.location.reload();
                } else {
                    alert(data.message || data.errors?.status?.[0] || 'Error updating status');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        }

        // ================================
        // LEGACY STATUS MODAL (kept for compatibility)
        // ================================
        const modal = document.getElementById('status-modal');
        const statusForm = document.getElementById('status-form');
        const modalOrderId = document.getElementById('modal-order-id');
        const statusSelect = document.getElementById('status');
        const cancellationReasonGroup = document.getElementById('cancellation-reason-group');
        const reasonInput = document.getElementById('reason');

        // Add error styling dynamically if not present
        if (!document.getElementById('error-style')) {
            const style = document.createElement('style');
            style.id = 'error-style';
            style.textContent = `
                .error-text { color: #dc3545; font-size: 0.8em; margin-top: 4px; display: block; }
                .form-group input.is-invalid, .form-group select.is-invalid, .form-group textarea.is-invalid { border-color: #dc3545; }
            `;
            document.head.appendChild(style);
        }

        function toggleCancellationReason() {
            // Show if status is 'cancelled', otherwise hide
            if (statusSelect && statusSelect.value === 'cancelled') {
                if (cancellationReasonGroup) cancellationReasonGroup.style.display = 'block';
            } else {
                if (cancellationReasonGroup) cancellationReasonGroup.style.display = 'none';
            }
        }
        // Only add listener if element exists
        if (statusSelect) {
            statusSelect.addEventListener('change', toggleCancellationReason);
        }

        function closeModal() {
            if (modal) modal.style.display = 'none';
            // Clear errors
            document.querySelectorAll('.error-text').forEach(el => el.remove());
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            if (statusForm) statusForm.reset();
        }

        function openStatusModal(btn) {
            const orderId = btn.dataset.id;
            const currentStatus = btn.dataset.status;
            const reason = btn.dataset.reason;

            statusForm.action = `/admin/orders/update_status/${orderId}`;
            modalOrderId.textContent = orderId;

            // Populate the reason field
            if (reasonInput) {
                reasonInput.value = reason || '';
            }

            // Allowed transitions mirror server-side rules
            const allowed = {
                'pending': ['processing', 'cancelled'],
                'processing': ['shipped', 'cancelled'],
                'shipped': ['completed'],
                'completed': [],
                'cancelled': []
            };

            // Enable/disable options based on current status
            Array.from(statusSelect.options).forEach(opt => {
                if (opt.value === currentStatus) {
                    opt.disabled = false;
                } else {
                    opt.disabled = !allowed[currentStatus] || !allowed[currentStatus].includes(opt.value);
                }
            });

            // Set value after disabling/enabling
            statusSelect.value = currentStatus;
            
            // Populate the reason field visibility
            toggleCancellationReason();
            
            modal.style.display = 'flex';
        }

        window.onclick = (event) => {
            if (modal && event.target == modal) closeModal();
        };

        // Handle Form Submission via AJAX (only if legacy form exists)
        if (statusForm) {
            statusForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(statusForm);
                const submitBtn = document.getElementById('save-btn');
                if (!submitBtn) return;
                const originalText = submitBtn.textContent;

                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                // Clear previous errors
                document.querySelectorAll('.error-text').forEach(el => el.remove());
                document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                fetch(statusForm.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json().then(data => ({status: response.status, body: data})))
                .then(result => {
                    if (result.status === 200 && result.body.success) {
                        window.location.reload();
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;

                        if (result.body.errors) {
                            for (const [field, errors] of Object.entries(result.body.errors)) {
                                const input = document.getElementById(field);
                                if (input) {
                                    input.classList.add('is-invalid');
                                    const errorSmall = document.createElement('small');
                                    errorSmall.className = 'error-text';
                                    errorSmall.textContent = errors[0];
                                    input.parentNode.appendChild(errorSmall);
                                }
                            }
                            // If reason error exists but field is hidden (edge case), show it
                            if (result.body.errors.reason && statusSelect && statusSelect.value === 'cancelled' && cancellationReasonGroup) {
                                cancellationReasonGroup.style.display = 'block';
                            }
                        } else {
                            alert('An error occurred. Please try again.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                })
            });
        }

        // Fade out flash messages
        window.addEventListener('DOMContentLoaded', (event) => {
            const flashMessages = document.querySelectorAll('.flash-message');
            if (flashMessages.length > 0) {
                setTimeout(() => {
                    flashMessages.forEach(message => {
                        message.style.transition = 'opacity 0.5s ease';
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 500); // Remove after fade
                    });
                }, 3000); // 3 seconds
            }
        });
    </script>
</body>
</html>